<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chennai Fleet TCO & Feasibility Simulator</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Prop Types -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 overflow-hidden transition-colors">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const {
            PieChart, Pie, Cell,
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
        } = Recharts;

        // --- Logic: Ported from calculations.ts ---

        const calculateTCO = (params) => {
            const { capex, opexFixed, opexVariable, market } = params;
            const operational = params.operational || {
                dailyOperationHours: 20, oneWayDistanceKm: 60, avgSpeedKph: 40,
                portWaitingHours: 3, loadingUnloadingHours: 1, workingDaysPerMonth: 25, targetTripsPerMonth: 26
            };
            const vehicleSpecs = params.vehicleSpecs || {
                fuelEfficiencyDrivingKml: 4.5, fuelEfficiencyIdlingLph: 2.5, adBlueConsumptionKml: 300
            };

            // --- Shuttle logic: Max trips and effective monthly trips ---
            const oneWayKm = operational.oneWayDistanceKm;
            const roundTripKm = oneWayKm * 2;
            const drivingTimePerTripHr = roundTripKm / (operational.avgSpeedKph || 1);
            const roundTripTimeHours = drivingTimePerTripHr + operational.portWaitingHours + operational.loadingUnloadingHours;
            const maxTripsPerDay = operational.dailyOperationHours / (roundTripTimeHours || 0.001);
            const workingDays = operational.workingDaysPerMonth;
            const effectiveMonthlyTrips = Math.min(operational.targetTripsPerMonth, maxTripsPerDay * workingDays);
            const monthlyDistance = roundTripKm * effectiveMonthlyTrips;

            // 1. EMI Calculation
            const principal = capex.vehicleCost * (1 - capex.downPaymentPercent / 100);
            const monthlyRate = capex.interestRate / 100 / 12;
            const n = capex.tenureMonths;
            let monthlyEmi = 0;
            if (monthlyRate > 0) {
                monthlyEmi = (principal * monthlyRate * Math.pow(1 + monthlyRate, n)) / (Math.pow(1 + monthlyRate, n) - 1);
            } else {
                monthlyEmi = principal / n;
            }

            // 2. Own Fleet costs (per vehicle per month)
            const mileageKml = vehicleSpecs.fuelEfficiencyDrivingKml;
            const idlingLph = vehicleSpecs.fuelEfficiencyIdlingLph;
            const idlingHoursPerMonth = effectiveMonthlyTrips * operational.portWaitingHours;
            const idlingFuelLiters = idlingHoursPerMonth * idlingLph;
            const drivingFuelLiters = monthlyDistance / (mileageKml || 1);
            const totalFuelLiters = drivingFuelLiters + idlingFuelLiters;
            const fuelCost = totalFuelLiters * opexVariable.dieselPrice;
            const idlingCost = idlingFuelLiters * opexVariable.dieselPrice;

            const adBlueLiters = (vehicleSpecs.adBlueConsumptionKml > 0) ? monthlyDistance / vehicleSpecs.adBlueConsumptionKml : 0;
            const adBlueCost = adBlueLiters * (opexVariable.adBluePricePerL || 0);

            const driverCost = opexFixed.driverBaseSalary + (opexFixed.driverBataPerTrip * effectiveMonthlyTrips);
            const helperCost = opexFixed.hasHelper ? opexFixed.helperSalary : 0;
            const annualToMonthly = (val) => val / 12;
            const maintenanceCost = monthlyDistance * opexVariable.maintenancePerKm;
            const tireCost = monthlyDistance * (opexVariable.tireCostPerKm || 0);
            const managementOverhead = opexFixed.managementOverheadMonthly ?? opexFixed.monthlyAdminOverhead;
            const fastTagTolls = opexFixed.fastTagTollsMonthly ?? 0;

            const fixedMonthlyCost = monthlyEmi +
                driverCost +
                helperCost +
                annualToMonthly(opexFixed.annualInsurance) +
                annualToMonthly(opexFixed.annualRoadTax) +
                annualToMonthly(opexFixed.annualFitnessExp) +
                managementOverhead +
                fastTagTolls;

            const variableCostTotal = fuelCost + adBlueCost + maintenanceCost + tireCost;
            const totalMonthlyOwnCostPerVehicle = fixedMonthlyCost + variableCostTotal;
            const totalMonthlyOwnCost = totalMonthlyOwnCostPerVehicle * capex.numVehicles;

            // 3. Outsource cost
            const outsourceTripRate = market.outsourceTripRate ?? market.unitRate;
            const fuelSurchargeTotal = (market.outsourceFuelSurchargePerTrip || 0) * effectiveMonthlyTrips * capex.numVehicles;
            const totalMonthlyOutsourceCost = (outsourceTripRate * effectiveMonthlyTrips * capex.numVehicles) + fuelSurchargeTotal;

            const monthlySavings = totalMonthlyOutsourceCost - totalMonthlyOwnCost;

            // 4. Break-even (trips)
            const variableCostPerTrip = (variableCostTotal) / (effectiveMonthlyTrips || 1);
            const fixedCostPerVehicleNoEmi = fixedMonthlyCost - monthlyEmi;
            const breakEvenTrips = (outsourceTripRate - variableCostPerTrip) > 0
                ? fixedMonthlyCost / (outsourceTripRate - variableCostPerTrip)
                : 999999;
            const costPerKm = monthlyDistance > 0 ? totalMonthlyOwnCostPerVehicle / monthlyDistance : 0;
            const costPerTripOwn = effectiveMonthlyTrips > 0 ? totalMonthlyOwnCostPerVehicle / effectiveMonthlyTrips : 0;
            const costPerTripOutsource = effectiveMonthlyTrips > 0 ? totalMonthlyOutsourceCost / (effectiveMonthlyTrips * capex.numVehicles) : outsourceTripRate;
            const fuelWeightage = totalMonthlyOwnCostPerVehicle > 0 ? (fuelCost / totalMonthlyOwnCostPerVehicle) * 100 : 0;

            return {
                monthlyEmi,
                fixedMonthlyCost,
                variableCostPerKm: variableCostTotal / (monthlyDistance || 1),
                totalMonthlyOwnCost,
                totalMonthlyOutsourceCost,
                totalMonthlyMarketCost: totalMonthlyOutsourceCost,
                monthlySavings,
                breakEvenDistance: breakEvenTrips * roundTripKm,
                breakEvenTrips,
                costPerKm,
                costPerTrip: costPerTripOwn,
                costPerTripOwn,
                costPerTripOutsource,
                fuelWeightage,
                idlingCost: idlingCost * capex.numVehicles,
                idlingCostPerVehicle: idlingCost,
                maxTripsPerDay,
                effectiveMonthlyTrips,
                roundTripTimeHours,
                monthlyDistance: monthlyDistance * capex.numVehicles
            };
        };

        const formatINR = (value) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(value);
        const formatLakh = (value) => `₹${(value / 100000).toFixed(2)} L`;

        // --- Report Export: generate HTML and trigger download ---
        const generateReportHtml = (params, results, aiReport) => {
            const date = new Date().toISOString().slice(0, 10);
            const p = params;
            const r = results;
            const aiHtml = aiReport ? aiReport.replace(/\n/g, '<br/>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/^### (.*)$/gm, '<h3 style="margin-top:1em;color:#1e293b">$1</h3>') : '<p class="muted">Run AI Consultant and save again to include AI analysis.</p>';
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chennai Fleet TCO Report - ${date}</title>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; max-width: 900px; margin: 0 auto; padding: 2rem; color: #1e293b; }
        h1 { font-size: 1.5rem; border-bottom: 2px solid #1e3a8a; padding-bottom: 0.5rem; }
        h2 { font-size: 1.1rem; margin-top: 1.5rem; color: #334155; }
        table { width: 100%; border-collapse: collapse; margin: 0.5rem 0 1rem; font-size: 0.9rem; }
        th, td { text-align: left; padding: 0.4rem 0.6rem; border-bottom: 1px solid #e2e8f0; }
        th { background: #f1f5f9; font-weight: 600; }
        .summary { background: #f8fafc; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .summary strong { color: #0f172a; }
        .muted { color: #64748b; font-style: italic; }
        .footer { margin-top: 2rem; font-size: 0.8rem; color: #94a3b8; }
        @media print { body { padding: 1rem; } }
    </style>
</head>
<body>
    <h1>Chennai Fleet TCO & Feasibility Report</h1>
    <p>Generated: ${new Date().toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' })}</p>

    <h2>1. Input Assumptions</h2>
    <table>
        <tr><th>CAPEX & Financing</th><th>Value</th></tr>
        <tr><td>Vehicle unit cost</td><td>${formatINR(p.capex.vehicleCost)}</td></tr>
        <tr><td>Down payment</td><td>${p.capex.downPaymentPercent}%</td></tr>
        <tr><td>Interest rate</td><td>${p.capex.interestRate}%</td></tr>
        <tr><td>Tenure</td><td>${p.capex.tenureMonths} months</td></tr>
        <tr><td>Number of vehicles</td><td>${p.capex.numVehicles}</td></tr>
    </table>
    ${p.operational ? `<table>
        <tr><th>Operational (Shuttle)</th><th>Value</th></tr>
        <tr><td>Daily operation hours</td><td>${p.operational.dailyOperationHours}</td></tr>
        <tr><td>One-way distance</td><td>${p.operational.oneWayDistanceKm} km</td></tr>
        <tr><td>Avg. speed</td><td>${p.operational.avgSpeedKph} km/h</td></tr>
        <tr><td>Port waiting/trip</td><td>${p.operational.portWaitingHours} hrs</td></tr>
        <tr><td>Loading/unloading</td><td>${p.operational.loadingUnloadingHours} hrs</td></tr>
        <tr><td>Working days/month</td><td>${p.operational.workingDaysPerMonth}</td></tr>
        <tr><td>Target trips/month</td><td>${p.operational.targetTripsPerMonth}</td></tr>
    </table>` : ''}
    ${p.vehicleSpecs ? `<table>
        <tr><th>Vehicle Specs</th><th>Value</th></tr>
        <tr><td>Fuel – Driving (km/L)</td><td>${p.vehicleSpecs.fuelEfficiencyDrivingKml}</td></tr>
        <tr><td>Fuel – Idling (L/hr)</td><td>${p.vehicleSpecs.fuelEfficiencyIdlingLph}</td></tr>
        <tr><td>AdBlue (km/L)</td><td>${p.vehicleSpecs.adBlueConsumptionKml}</td></tr>
    </table>` : ''}
    <table>
        <tr><th>Driver & Admin (Own Fleet)</th><th>Value</th></tr>
        <tr><td>Driver fixed (₹/mo)</td><td>${formatINR(p.opexFixed.driverBaseSalary)}</td></tr>
        <tr><td>Driver bata/trip (₹)</td><td>${formatINR(p.opexFixed.driverBataPerTrip != null ? p.opexFixed.driverBataPerTrip : p.opexFixed.tripIncentive)}</td></tr>
        <tr><td>Helper</td><td>${p.opexFixed.hasHelper ? formatINR(p.opexFixed.helperSalary) : 'No'}</td></tr>
        <tr><td>Management overhead (₹/mo)</td><td>${formatINR(p.opexFixed.managementOverheadMonthly != null ? p.opexFixed.managementOverheadMonthly : p.opexFixed.monthlyAdminOverhead)}</td></tr>
        <tr><td>FastTag & Tolls (₹/mo)</td><td>${formatINR(p.opexFixed.fastTagTollsMonthly || 0)}</td></tr>
        <tr><td>Annual insurance / road tax / fitness</td><td>${formatINR(p.opexFixed.annualInsurance)} / ${formatINR(p.opexFixed.annualRoadTax)} / ${formatINR(p.opexFixed.annualFitnessExp)}</td></tr>
    </table>
    <table>
        <tr><th>Fuel & Variable</th><th>Value</th></tr>
        <tr><td>Diesel (₹/L)</td><td>${formatINR(p.opexVariable.dieselPrice)}</td></tr>
        <tr><td>AdBlue (₹/L)</td><td>${formatINR(p.opexVariable.adBluePricePerL || 0)}</td></tr>
        <tr><td>Tire / Maintenance (₹/km)</td><td>${p.opexVariable.tireCostPerKm} / ${p.opexVariable.maintenancePerKm}</td></tr>
    </table>
    <table>
        <tr><th>Outsource Benchmark</th><th>Value</th></tr>
        <tr><td>Trip rate (₹/trip)</td><td>${formatINR(p.market.outsourceTripRate != null ? p.market.outsourceTripRate : p.market.unitRate)}</td></tr>
        <tr><td>Fuel surcharge (₹/trip)</td><td>${formatINR(p.market.outsourceFuelSurchargePerTrip || 0)}</td></tr>
    </table>

    <h2>2. Simulation Results</h2>
    <div class="summary">
        <table>
            <tr><td><strong>Own vs Outsource – Cost per trip</strong></td><td>${formatINR(r.costPerTripOwn != null ? r.costPerTripOwn : r.costPerTrip)} (Own) / ${formatINR(r.costPerTripOutsource)} (Outsource)</td></tr>
            <tr><td><strong>Total monthly – Own</strong></td><td>${formatINR(r.totalMonthlyOwnCost)}</td></tr>
            <tr><td><strong>Total monthly – Outsource</strong></td><td>${formatINR(r.totalMonthlyOutsourceCost != null ? r.totalMonthlyOutsourceCost : r.totalMonthlyMarketCost)}</td></tr>
            <tr><td><strong>Monthly savings (total fleet)</strong></td><td>${formatINR(r.monthlySavings)}</td></tr>
            <tr><td><strong>Break-even (trips/month)</strong></td><td>${typeof r.breakEvenTrips === 'number' && isFinite(r.breakEvenTrips) ? Math.round(r.breakEvenTrips).toLocaleString() : '—'} trips</td></tr>
            <tr><td><strong>Idling cost (port waiting, ₹/mo)</strong></td><td>${formatINR(r.idlingCost != null ? r.idlingCost : 0)}</td></tr>
            <tr><td>Cost per km</td><td>₹${(r.costPerKm || 0).toFixed(2)}</td></tr>
            <tr><td>Monthly EMI (per unit)</td><td>${formatINR(r.monthlyEmi)}</td></tr>
            <tr><td>Fuel weight in cost</td><td>${(r.fuelWeightage || 0).toFixed(1)}%</td></tr>
            <tr><td>Payback (months, down payment)</td><td>${r.monthlySavings > 0 ? ((p.capex.vehicleCost * (p.capex.downPaymentPercent / 100) * p.capex.numVehicles) / r.monthlySavings).toFixed(1) : 'N/A'}</td></tr>
        </table>
    </div>

    <h2>3. AI Consultant (if run)</h2>
    <div>${aiHtml}</div>

    <p class="footer">This report was generated by Chennai Fleet TCO Simulator. For latest assumptions, re-run the simulator and export again.</p>
</body>
</html>`;
        };

        const downloadReport = (params, results, aiReport) => {
            const html = generateReportHtml(params, results, aiReport);
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Chennai_TCO_Report_${new Date().toISOString().slice(0, 10)}_${Date.now().toString().slice(-6)}.html`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // --- AI Business Analyst: Chennai logistics heuristic validation & strategic recommendations ---
        const generateAIAnalysis = (params, results) => {
            const validations = [];
            const recommendations = [];
            const op = params.operational || {};
            const vs = params.vehicleSpecs || {};
            const opex = params.opexVariable || {};
            const opexFixed = params.opexFixed || {};
            const bata = opexFixed.driverBataPerTrip != null ? opexFixed.driverBataPerTrip : opexFixed.tripIncentive;

            // 1. Traffic & Speed Reality Check
            const avgSpeed = op.avgSpeedKph ?? 0;
            if (avgSpeed > 35) {
                validations.push({ type: 'caution', label: 'Traffic & Speed', message: `High Speed Alert: The average truck speed on Chennai-Ennore port roads is typically 20-30 km/h due to congestion. Your input of ${avgSpeed} km/h is highly optimistic.` });
            } else {
                validations.push({ type: 'ok', label: 'Traffic & Speed' });
            }

            // 2. Driver Compensation (Bata) Check
            const bataNum = typeof bata === 'number' ? bata : parseFloat(bata) || 0;
            if (bataNum === 0 || bataNum < 200) {
                validations.push({ type: 'caution', label: 'Driver Bata', message: 'Driver Risk: In Tamil Nadu, drivers expect a daily "Bata" (allowance). Without this, retention will be difficult. Recommended: ₹300-500 per trip/day.' });
            } else {
                validations.push({ type: 'ok', label: 'Driver Bata' });
            }

            // 3. Fuel Efficiency Check (BS6 & Traffic, 40ft trailer)
            const fuelKml = vs.fuelEfficiencyDrivingKml ?? opex.mileageKml ?? 0;
            if (fuelKml > 3.5) {
                validations.push({ type: 'caution', label: 'Fuel Economy', message: 'Optimistic Fuel Economy: Considering Stop-and-Go traffic at Chennai ports, 2.5 - 3.0 km/L is more realistic for loaded trailers.' });
            } else {
                validations.push({ type: 'ok', label: 'Fuel Economy' });
            }

            // 4. Port Detention Reality
            const portWait = op.portWaitingHours ?? 0;
            if (portWait < 2 && portWait >= 0) {
                validations.push({ type: 'caution', label: 'Port Detention', message: 'Port Congestion: Entry/Exit queues at Chennai/Kattupalli ports often exceed 3-4 hours. Your 2-hour estimate may lead to underestimating costs.' });
            } else {
                validations.push({ type: 'ok', label: 'Port Detention' });
            }

            // Strategic recommendations
            const outsourceTotal = results.totalMonthlyOutsourceCost ?? results.totalMonthlyMarketCost ?? 1;
            const ownTotal = results.totalMonthlyOwnCost ?? 0;
            const savingsPercent = outsourceTotal > 0 ? ((outsourceTotal - ownTotal) / outsourceTotal) * 100 : 0;

            if (savingsPercent >= 0 && savingsPercent < 10) {
                recommendations.push({ iconClass: 'ph-fill ph-trend-down text-rose-500 dark:text-rose-400', text: 'Recommendation: Stick to Outsourcing. The cost saving (<10%) is too small to justify the risks of owning assets (accidents, police issues, RTO bribes, driver strikes) in India.' });
            } else if (savingsPercent > 20) {
                recommendations.push({ iconClass: 'ph-fill ph-truck text-blue-500 dark:text-blue-400', text: 'Recommendation: Consider Hybrid Model. The savings are significant. Start with 2-3 owned trucks to handle base load and use market vehicles for peak demand to manage initial capex risk.' });
            }

            const adBluePrice = opex.adBluePricePerL != null ? opex.adBluePricePerL : 0;
            const adBlueKml = vs.adBlueConsumptionKml;
            if (!adBluePrice || adBluePrice === 0 || !adBlueKml || adBlueKml <= 0) {
                recommendations.push({ iconClass: 'ph-fill ph-drop text-sky-500 dark:text-sky-400', text: 'Compliance Check: BS-VI vehicles require AdBlue. Ensure you have factored in approx. 5-7% of fuel costs for AdBlue, otherwise, your OPEX is underestimated.' });
            }

            return { validations, recommendations };
        };

        // --- Mock AI Logic (Rule-based) ---
        const generateMockAIReport = (params, result) => {
            return new Promise(resolve => {
                setTimeout(() => {
                    const isProfitable = result.monthlySavings > 0;

                    let verdict = isProfitable ? "**VERDICT: INVESTMENT RECOMMENDED**" : "**VERDICT: HOLD / HIGH RISK**";

                    let riskAnalysis = "### Risk Analysis\n";
                    if (result.fuelWeightage > 45) riskAnalysis += "- **High Fuel Dependency**: Fuel accounts for >45% of costs. Small price hikes will impact margins significantly.\n";
                    const effectiveTrips = result.effectiveMonthlyTrips ?? 0;
                    const breakEvenTrips = result.breakEvenTrips ?? 0;
                    if (effectiveTrips < 20) riskAnalysis += "- **Low Utilization**: Current trip count is low. Fixed costs per trip are inflating the TCO.\n";
                    if (breakEvenTrips > 0 && effectiveTrips < breakEvenTrips) riskAnalysis += "- **Below Break-even**: Current utilization is below the break-even trips.\n";
                    else if (breakEvenTrips > 0) riskAnalysis += "- **Healthy Utilization**: Operating above break-even point.\n";
                    if (result.idlingCost > 0) riskAnalysis += `- **Port Idling**: ₹${Math.round(result.idlingCost).toLocaleString()}/month lost to idling at port. Consider reducing detention time.\n`;

                    let actionPlan = "### Action Plan\n";
                    const mileageKml = params.vehicleSpecs?.fuelEfficiencyDrivingKml ?? params.opexVariable?.mileageKml ?? 4.5;
                    if (isProfitable) {
                        actionPlan += `1. **Execute Acquisition**: Proceed with purchasing ${params.capex.numVehicles} units.\n2. **Fuel Monitoring**: Implement telematics to maintain mileage at ${mileageKml} km/L.\n3. **Driver Retention**: Ensure competitive incentives to maintain ${effectiveTrips} trips/month.`;
                    } else {
                        actionPlan += `1. **Negotiate Rates**: Outsource rates may be too low to justify ownership. Negotiate or increase utilization.\n2. **Increase Utilization**: Need at least ${Math.ceil(breakEvenTrips)} trips/month per vehicle to break even.\n3. **Review Maintenance**: Check if AMC can be lowered.`;
                    }

                    resolve(`${verdict}\n\n${riskAnalysis}\n${actionPlan}`);
                }, 1000);
            });
        };

        // --- Components ---

        const INITIAL_PARAMS = {
            capex: {
                vehicleCost: 4200000,
                downPaymentPercent: 20,
                interestRate: 11,
                tenureMonths: 60,
                residualValue: 800000,
                numVehicles: 9
            },
            operational: {
                dailyOperationHours: 20,
                oneWayDistanceKm: 60,
                avgSpeedKph: 40,
                portWaitingHours: 3,
                loadingUnloadingHours: 1,
                workingDaysPerMonth: 25,
                targetTripsPerMonth: 26
            },
            vehicleSpecs: {
                fuelEfficiencyIdlingLph: 2.5,
                fuelEfficiencyDrivingKml: 4.5,
                adBlueConsumptionKml: 300
            },
            opexFixed: {
                driverBaseSalary: 22000,
                dailyBhatta: 450,
                tripIncentive: 500,
                driverBataPerTrip: 500,
                helperSalary: 12000,
                hasHelper: false,
                annualInsurance: 95000,
                roadTaxType: 'National',
                annualRoadTax: 32000,
                annualFitnessExp: 15000,
                monthlyAdminOverhead: 5000,
                managementOverheadMonthly: 5000,
                fastTagTollsMonthly: 30000
            },
            opexVariable: {
                dieselPrice: 94.5,
                mileageKml: 4.5,
                tireCostPerKm: 1.8,
                maintenancePerKm: 1.2,
                adBluePricePerL: 45,
                fastagPerTrip: 1200,
                incidentalsPerTrip: 800
            },
            market: {
                unitType: 'Trip',
                unitRate: 12500,
                outsourceTripRate: 12500,
                outsourceFuelSurchargePerTrip: 0,
                tripDistance: 120,
                monthlyTrips: 26
            }
        };

        const COLORS = ['#1e3a8a', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'];

        const THEME_KEY = 'chennai-tco-theme';

        function App() {
            const [params, setParams] = useState(INITIAL_PARAMS);
            const [aiReport, setAiReport] = useState(null);
            const [loadingAI, setLoadingAI] = useState(false);
            const [theme, setTheme] = useState(() => {
                try { return localStorage.getItem(THEME_KEY) || 'light'; } catch { return 'light'; }
            });

            useEffect(() => {
                const root = document.documentElement;
                if (theme === 'dark') root.classList.add('dark');
                else root.classList.remove('dark');
                try { localStorage.setItem(THEME_KEY, theme); } catch (_) {}
            }, [theme]);

            const results = useMemo(() => calculateTCO(params), [params]);
            const aiAnalysis = useMemo(() => generateAIAnalysis(params, results), [params, results]);

            const handleInputChange = (section, field, value) => {
                setParams(prev => ({
                    ...prev,
                    [section]: {
                        ...prev[section],
                        [field]: value
                    }
                }));
                if (aiReport) setAiReport(null);
            };

            const handleAnalyze = async () => {
                setLoadingAI(true);
                const report = await generateMockAIReport(params, results);
                setAiReport(report);
                setLoadingAI(false);
            };

            // Data for Charts (per-vehicle cost for breakdown)
            const effectiveTrips = results.effectiveMonthlyTrips ?? 0;
            const roundTripKm = (params.operational?.oneWayDistanceKm ?? 60) * 2;
            const monthlyDistPerVehicle = roundTripKm * effectiveTrips;
            const costPerVehicle = results.totalMonthlyOwnCost / (params.capex.numVehicles || 1);
            const bata = params.opexFixed.driverBataPerTrip != null ? params.opexFixed.driverBataPerTrip : params.opexFixed.tripIncentive;
            const personnelCost = (params.opexFixed.driverBaseSalary + (bata * effectiveTrips)) + (params.opexFixed.hasHelper ? params.opexFixed.helperSalary : 0);
            const maintenanceCost = params.opexVariable.maintenancePerKm * monthlyDistPerVehicle;
            const emiShare = costPerVehicle > 0 ? (results.monthlyEmi / costPerVehicle) * 100 : 0;
            const personnelShare = costPerVehicle > 0 ? (personnelCost / costPerVehicle) * 100 : 0;
            const maintenanceShare = costPerVehicle > 0 ? (maintenanceCost / costPerVehicle) * 100 : 0;
            const othersShare = Math.max(0, 100 - results.fuelWeightage - emiShare - personnelShare - maintenanceShare);
            const pieData = [
                { name: 'Fuel', value: results.fuelWeightage },
                { name: 'EMI', value: emiShare },
                { name: 'Personnel', value: personnelShare },
                { name: 'Maintenance', value: maintenanceShare },
                { name: 'Others', value: othersShare }
            ].filter(d => d.value > 0);

            const sensitivityData = useMemo(() => {
                const tripDist = roundTripKm;
                const tripsRef = results.breakEvenTrips ?? 0;
                return Array.from({ length: 11 }, (_, i) => {
                    const trips = Math.max(1, (tripsRef * 0.5) + (tripsRef * i * 0.1));
                    const dist = trips * tripDist;
                    if (!isFinite(dist) || dist <= 0) return { trips: 0, Own: 0, Outsource: 0 };

                    const ownCost = (results.fixedMonthlyCost + (results.variableCostPerKm * dist)) * params.capex.numVehicles;
                    const outsourceRate = params.market.outsourceTripRate ?? params.market.unitRate;
                    const outsourceCost = outsourceRate * trips * params.capex.numVehicles;
                    return {
                        trips: Math.round(trips),
                        Own: Math.round(ownCost),
                        Outsource: Math.round(outsourceCost)
                    };
                });
            }, [results, params, roundTripKm]);

            return (
                <div className={`min-h-screen flex flex-col bg-slate-50 dark:bg-slate-900 ${theme === 'dark' ? 'dark' : ''}`}>
                    {/* Header */}
                    <header className="bg-slate-900 dark:bg-slate-950 text-white px-6 py-4 shadow-lg flex justify-between items-center sticky top-0 z-50">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-lg">
                                <i className="ph-fill ph-truck text-2xl"></i>
                            </div>
                            <div>
                                <h1 className="text-xl font-bold tracking-tight">Chennai Fleet TCO & Feasibility</h1>
                            </div>
                        </div>
                        <div className="flex items-center gap-3 sm:gap-4">
                            <div className="flex items-center gap-1 rounded-lg bg-slate-800 dark:bg-slate-800/80 p-1">
                                <button
                                    onClick={() => setTheme('light')}
                                    className={`px-2.5 py-1.5 rounded-md text-xs font-medium transition-colors ${theme === 'light' ? 'bg-white text-slate-900 shadow' : 'text-slate-300 hover:text-white'}`}
                                    title="Light mode"
                                >
                                    <i className="ph ph-sun align-middle mr-1"></i> Light
                                </button>
                                <button
                                    onClick={() => setTheme('dark')}
                                    className={`px-2.5 py-1.5 rounded-md text-xs font-medium transition-colors ${theme === 'dark' ? 'bg-white text-slate-900 shadow' : 'text-slate-300 hover:text-white'}`}
                                    title="Dark mode"
                                >
                                    <i className="ph ph-moon align-middle mr-1"></i> Dark
                                </button>
                            </div>
                            <div className="text-right hidden sm:block">
                                <p className="text-xs text-slate-400">Total Fleet</p>
                                <p className="text-sm font-semibold">{params.capex.numVehicles} x Ashok Leyland 20FT</p>
                            </div>
                            <button
                                onClick={() => downloadReport(params, results, aiReport)}
                                className="bg-slate-700 hover:bg-slate-600 transition-colors px-4 py-2 rounded-lg flex items-center gap-2 font-medium text-sm border border-slate-600"
                                title="Save simulation report as HTML file"
                            >
                                <i className="ph ph-file-arrow-down text-lg"></i>
                                Save Report
                            </button>
                            <button
                                onClick={handleAnalyze}
                                disabled={loadingAI}
                                className="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 transition-colors px-4 py-2 rounded-lg flex items-center gap-2 font-medium text-sm"
                            >
                                {loadingAI ? <i className="ph ph-spinner animate-spin text-lg"></i> : <i className="ph ph-brain text-lg"></i>}
                                AI Consultant
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 flex flex-col lg:flex-row h-full overflow-hidden">
                        {/* Left: Input Sidebar */}
                        <aside className="w-full lg:w-[400px] border-r border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 overflow-y-auto p-6 flex flex-col gap-8 shrink-0 h-[calc(100vh-80px)] custom-scrollbar">

                            <Section icon="ph-currency-inr" title="CAPEX & Financing">
                                <Input label="Vehicle Unit Cost (₹)" value={params.capex.vehicleCost} onChange={v => handleInputChange('capex', 'vehicleCost', v)} type="number" />
                                <div className="grid grid-cols-2 gap-3">
                                    <Input label="Downpayment (%)" value={params.capex.downPaymentPercent} onChange={v => handleInputChange('capex', 'downPaymentPercent', v)} type="number" />
                                    <Input label="Interest Rate (%)" value={params.capex.interestRate} onChange={v => handleInputChange('capex', 'interestRate', v)} type="number" />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <Input label="Tenure (Months)" value={params.capex.tenureMonths} onChange={v => handleInputChange('capex', 'tenureMonths', v)} type="number" />
                                    <Input label="Units" value={params.capex.numVehicles} onChange={v => handleInputChange('capex', 'numVehicles', v)} type="number" />
                                </div>
                            </Section>

                            <Section icon="ph-clock-clockwise" title="Operational (Shuttle Efficiency)">
                                <Input label="Daily Operation Hours" value={params.operational.dailyOperationHours} onChange={v => handleInputChange('operational', 'dailyOperationHours', v)} type="number" />
                                <Input label="One-way Distance (km)" value={params.operational.oneWayDistanceKm} onChange={v => handleInputChange('operational', 'oneWayDistanceKm', v)} type="number" />
                                <Input label="Avg. Speed (km/h)" value={params.operational.avgSpeedKph} onChange={v => handleInputChange('operational', 'avgSpeedKph', v)} type="number" />
                                <Input label="Port Waiting/Detention (hrs/trip)" value={params.operational.portWaitingHours} onChange={v => handleInputChange('operational', 'portWaitingHours', v)} type="number" step="0.5" />
                                <Input label="Loading/Unloading at Factory (hrs)" value={params.operational.loadingUnloadingHours} onChange={v => handleInputChange('operational', 'loadingUnloadingHours', v)} type="number" step="0.5" />
                                <div className="grid grid-cols-2 gap-3">
                                    <Input label="Working Days/Month" value={params.operational.workingDaysPerMonth} onChange={v => handleInputChange('operational', 'workingDaysPerMonth', v)} type="number" />
                                    <Input label="Target Trips/Month" value={params.operational.targetTripsPerMonth} onChange={v => handleInputChange('operational', 'targetTripsPerMonth', v)} type="number" />
                                </div>
                                <div className="p-3 bg-blue-50 dark:bg-blue-900/30 border border-blue-100 dark:border-blue-800 rounded-lg">
                                    <p className="text-[11px] font-semibold text-blue-700 dark:text-blue-300 uppercase">Max Trips/Day</p>
                                    <p className="text-lg font-bold text-blue-900 dark:text-blue-100">{results.maxTripsPerDay != null ? results.maxTripsPerDay.toFixed(1) : '—'}</p>
                                    <p className="text-[10px] text-slate-500 dark:text-slate-400 mt-0.5">Round-trip time: {results.roundTripTimeHours != null ? results.roundTripTimeHours.toFixed(1) : '—'} hrs</p>
                                </div>
                            </Section>

                            <Section icon="ph-truck" title="Vehicle Specs">
                                <Input label="Fuel Efficiency – Driving (km/L)" value={params.vehicleSpecs.fuelEfficiencyDrivingKml} onChange={v => handleInputChange('vehicleSpecs', 'fuelEfficiencyDrivingKml', v)} type="number" step="0.1" />
                                <Input label="Fuel Efficiency – Idling (L/hr at port)" value={params.vehicleSpecs.fuelEfficiencyIdlingLph} onChange={v => handleInputChange('vehicleSpecs', 'fuelEfficiencyIdlingLph', v)} type="number" step="0.1" />
                                <Input label="AdBlue Consumption (km/L)" value={params.vehicleSpecs.adBlueConsumptionKml} onChange={v => handleInputChange('vehicleSpecs', 'adBlueConsumptionKml', v)} type="number" />
                            </Section>

                            <Section icon="ph-user-gear" title="India Cost – Driver & Admin (Own Fleet)">
                                <Input label="Driver Fixed Salary (₹/Mo)" value={params.opexFixed.driverBaseSalary} onChange={v => handleInputChange('opexFixed', 'driverBaseSalary', v)} type="number" />
                                <Input label="Driver Bata / Per Trip (₹)" value={params.opexFixed.driverBataPerTrip != null ? params.opexFixed.driverBataPerTrip : params.opexFixed.tripIncentive} onChange={v => handleInputChange('opexFixed', 'driverBataPerTrip', v)} type="number" />
                                <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg border border-slate-100 dark:border-slate-600">
                                    <label className="text-xs font-semibold text-slate-500 dark:text-slate-400">Include Helper?</label>
                                    <input
                                        type="checkbox"
                                        checked={params.opexFixed.hasHelper}
                                        onChange={e => handleInputChange('opexFixed', 'hasHelper', e.target.checked)}
                                        className="w-5 h-5 accent-blue-600"
                                    />
                                </div>
                                {params.opexFixed.hasHelper && (
                                    <Input label="Helper Salary (₹/Mo)" value={params.opexFixed.helperSalary} onChange={v => handleInputChange('opexFixed', 'helperSalary', v)} type="number" />
                                )}
                                <Input label="Management Overhead (₹/Mo)" value={params.opexFixed.managementOverheadMonthly != null ? params.opexFixed.managementOverheadMonthly : params.opexFixed.monthlyAdminOverhead} onChange={v => handleInputChange('opexFixed', 'managementOverheadMonthly', v)} type="number" />
                                <Input label="FastTag & Tolls (₹/Mo avg)" value={params.opexFixed.fastTagTollsMonthly} onChange={v => handleInputChange('opexFixed', 'fastTagTollsMonthly', v)} type="number" />
                            </Section>

                            <Section icon="ph-gas-pump" title="Fuel, AdBlue & Variable (Own Fleet)">
                                <div className="grid grid-cols-2 gap-3">
                                    <Input label="Diesel (₹/L)" value={params.opexVariable.dieselPrice} onChange={v => handleInputChange('opexVariable', 'dieselPrice', v)} type="number" />
                                    <Input label="AdBlue (₹/L)" value={params.opexVariable.adBluePricePerL} onChange={v => handleInputChange('opexVariable', 'adBluePricePerL', v)} type="number" />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <Input label="Tires (₹/km)" value={params.opexVariable.tireCostPerKm} onChange={v => handleInputChange('opexVariable', 'tireCostPerKm', v)} type="number" />
                                    <Input label="Maintenance (₹/km)" value={params.opexVariable.maintenancePerKm} onChange={v => handleInputChange('opexVariable', 'maintenancePerKm', v)} type="number" />
                                </div>
                            </Section>

                            <Section icon="ph-chart-pie-slice" title="Outsource Benchmark">
                                <Input label="Outsource Trip Rate (₹/trip)" value={params.market.outsourceTripRate != null ? params.market.outsourceTripRate : params.market.unitRate} onChange={v => handleInputChange('market', 'outsourceTripRate', v)} type="number" />
                                <Input label="Fuel Surcharge (₹/trip, optional)" value={params.market.outsourceFuelSurchargePerTrip != null ? params.market.outsourceFuelSurchargePerTrip : 0} onChange={v => handleInputChange('market', 'outsourceFuelSurchargePerTrip', v)} type="number" />
                                <div className="p-2 bg-slate-50 dark:bg-slate-700/50 rounded text-[11px] text-slate-500 dark:text-slate-400">
                                    Effective trips/month: <strong className="text-slate-700 dark:text-slate-200">{results.effectiveMonthlyTrips != null ? Math.round(results.effectiveMonthlyTrips) : '—'}</strong> (min of target vs max achievable)
                                </div>
                            </Section>

                            {/* Spacer to allow scrolling to bottom */}
                            <div className="h-6"></div>
                        </aside>

                        {/* Right: Dashboard */}
                        <div className="flex-1 overflow-y-auto p-6 space-y-6 h-[calc(100vh-80px)] bg-slate-50/50 dark:bg-slate-900/80 custom-scrollbar">

                            {/* Own vs Outsource Comparison Table */}
                            <Card title="Own Fleet vs Outsource Comparison">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-slate-200 dark:border-slate-600">
                                                <th className="text-left py-3 px-2 font-semibold text-slate-600 dark:text-slate-300">Metric</th>
                                                <th className="text-right py-3 px-2 font-semibold text-blue-700 dark:text-blue-400">Own Fleet</th>
                                                <th className="text-right py-3 px-2 font-semibold text-amber-700 dark:text-amber-400">Outsource</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr className="border-b border-slate-100 dark:border-slate-600">
                                                <td className="py-2 px-2 text-slate-600 dark:text-slate-300">Cost per Trip</td>
                                                <td className="text-right font-medium text-slate-900 dark:text-slate-100">{formatINR(results.costPerTripOwn ?? results.costPerTrip)}</td>
                                                <td className="text-right font-medium text-slate-900 dark:text-slate-100">{formatINR(results.costPerTripOutsource)}</td>
                                            </tr>
                                            <tr className="border-b border-slate-100 dark:border-slate-600">
                                                <td className="py-2 px-2 text-slate-600 dark:text-slate-300">Total Monthly Cost ({params.capex.numVehicles} units)</td>
                                                <td className="text-right font-medium text-slate-900 dark:text-slate-100">{formatINR(results.totalMonthlyOwnCost)}</td>
                                                <td className="text-right font-medium text-slate-900 dark:text-slate-100">{formatINR(results.totalMonthlyOutsourceCost)}</td>
                                            </tr>
                                            <tr className="border-b border-slate-100 dark:border-slate-600">
                                                <td className="py-2 px-2 text-slate-600 dark:text-slate-300">Break-even (trips/month)</td>
                                                <td colSpan="2" className="text-right font-bold text-slate-800 dark:text-slate-100">{typeof results.breakEvenTrips === 'number' && isFinite(results.breakEvenTrips) ? Math.round(results.breakEvenTrips).toLocaleString() : '—'} trips</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div className="mt-4 p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700 rounded-xl">
                                    <p className="text-xs font-bold text-amber-800 dark:text-amber-300 uppercase">Idling Cost (Port Waiting)</p>
                                    <p className="text-2xl font-bold text-amber-900 dark:text-amber-200 mt-1">{formatINR(results.idlingCost ?? 0)}</p>
                                    <p className="text-xs text-amber-700 dark:text-amber-400 mt-1">Wasted on fuel during port detention per month (total fleet). Reduce port wait to lower this.</p>
                                </div>
                            </Card>

                            {/* Summary Cards */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <SummaryCard
                                    label="Monthly Savings"
                                    value={formatINR(results.monthlySavings)}
                                    trend={results.monthlySavings > 0 ? 'up' : 'down'}
                                    sub={`Own vs Outsource (${params.capex.numVehicles} units)`}
                                />
                                <SummaryCard
                                    label="Break-even (Trips)"
                                    value={typeof results.breakEvenTrips === 'number' && isFinite(results.breakEvenTrips) ? `${Math.round(results.breakEvenTrips)}` : '—'}
                                    sub="Trips/month to match outsource cost"
                                    icon="ph-check-circle"
                                />
                                <SummaryCard
                                    label="Cost Per Trip (Own)"
                                    value={formatINR(results.costPerTripOwn ?? results.costPerTrip)}
                                    sub="Per vehicle"
                                />
                                <SummaryCard
                                    label="Cost Per KM"
                                    value={`₹${(results.costPerKm || 0).toFixed(2)}`}
                                    sub="Fully loaded cost"
                                />
                            </div>

                            {/* AI Analyst Report - runs with calculation */}
                            <div className="rounded-2xl border border-sky-200 dark:border-sky-800 bg-gradient-to-br from-sky-50 to-amber-50/60 dark:from-slate-800 dark:to-slate-800/80 p-6 shadow-sm">
                                <h3 className="text-base font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2 mb-4">
                                    <i className="ph-bold ph-robot text-blue-600 dark:text-blue-400 text-xl"></i>
                                    AI Analyst Report
                                </h3>
                                <div className="space-y-3">
                                    <p className="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">Validation Checks</p>
                                    {aiAnalysis.validations.map((v, i) => (
                                        <div key={i} className={`flex items-start gap-3 p-3 rounded-lg ${v.type === 'ok' ? 'bg-white/80 dark:bg-slate-700/50 border border-slate-100 dark:border-slate-600' : 'bg-amber-50/90 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700'}`}>
                                            <span className="shrink-0 mt-0.5">
                                                {v.type === 'ok' ? <i className="ph-fill ph-check-circle text-emerald-500 dark:text-emerald-400 text-lg"></i> : <i className="ph-fill ph-warning text-amber-500 dark:text-amber-400 text-lg"></i>}
                                            </span>
                                            <div>
                                                <span className={`text-sm font-semibold ${v.type === 'ok' ? 'text-slate-700 dark:text-slate-200' : 'text-amber-800 dark:text-amber-200'}`}>
                                                    {v.type === 'ok' ? 'Reasonable' : 'Caution'}: {v.label}
                                                </span>
                                                {v.message && <p className="text-xs text-slate-600 dark:text-slate-300 mt-1">{v.message}</p>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {aiAnalysis.recommendations.length > 0 && (
                                    <div className="mt-5 pt-4 border-t border-sky-200 dark:border-slate-600">
                                        <p className="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase mb-2">Strategic Recommendation</p>
                                        {aiAnalysis.recommendations.map((r, i) => (
                                            <div key={i} className="flex items-start gap-2 mt-2">
                                                <i className={`shrink-0 mt-0.5 text-lg ${r.iconClass}`}></i>
                                                <p className="text-sm font-bold text-slate-900 dark:text-slate-100">{r.text}</p>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Charts Row */}
                            <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                                <Card title="Sensitivity Analysis (Cost vs Trips/Month)">
                                    <div className="h-[300px] w-full mt-4">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <LineChart data={sensitivityData} margin={{ top: 20, right: 30, left: 10, bottom: 20 }}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                <XAxis dataKey="trips" label={{ value: 'Trips per month', position: 'insideBottom', offset: -10 }} />
                                                <YAxis tickFormatter={(val) => `₹${(val / 1000).toFixed(0)}k`} />
                                                <Tooltip formatter={(val) => formatINR(val)} />
                                                <Legend verticalAlign="top" height={36} />
                                                <Line type="monotone" dataKey="Own" stroke="#1e3a8a" strokeWidth={3} dot={false} />
                                                <Line type="monotone" dataKey="Outsource" stroke="#f59e0b" strokeWidth={3} dot={false} strokeDasharray="5 5" />
                                            </LineChart>
                                        </ResponsiveContainer>
                                    </div>
                                    <p className="text-xs text-slate-500 dark:text-slate-400 mt-2 italic text-center">
                                        * Intersection: Break-even trips where owning becomes cheaper than outsource
                                    </p>
                                </Card>

                                <Card title="Cost Structure Breakdown">
                                    <div className="h-[300px] flex items-center">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart>
                                                <Pie
                                                    data={pieData}
                                                    innerRadius={60}
                                                    outerRadius={100}
                                                    paddingAngle={5}
                                                    dataKey="value"
                                                >
                                                    {pieData.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                    ))}
                                                </Pie>
                                                <Tooltip />
                                                <Legend />
                                            </PieChart>
                                        </ResponsiveContainer>
                                        <div className="flex flex-col gap-2 pr-6">
                                            {pieData.map((d, i) => (
                                                <div key={d.name} className="flex items-center gap-2 max-w-[120px]">
                                                    <div className="w-3 h-3 rounded-full shrink-0" style={{ backgroundColor: COLORS[i % COLORS.length] }} />
                                                    <span className="text-xs font-medium text-slate-600 dark:text-slate-300 truncate">{d.name}: {d.value.toFixed(1)}%</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </Card>
                            </div>

                            {/* AI Insights & Detailed Analysis */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-2 space-y-6">
                                    <Card title="Estimated ROI & Cash Flow">
                                        <div className="grid grid-cols-2 gap-8 mt-4">
                                            <div className="space-y-4">
                                                <DataItem label="Vehicle Unit CAPEX" value={formatLakh(params.capex.vehicleCost)} />
                                                <DataItem label="Downpayment" value={formatLakh(params.capex.vehicleCost * (params.capex.downPaymentPercent / 100))} />
                                                <DataItem label="Monthly EMI (per Unit)" value={formatINR(results.monthlyEmi)} />
                                            </div>
                                            <div className="space-y-4">
                                                <DataItem label="Monthly Opex (Total)" value={formatINR(results.totalMonthlyOwnCost - (results.monthlyEmi * params.capex.numVehicles))} />
                                                <DataItem label="Annual Potential Saving" value={formatINR(results.monthlySavings * 12)} />
                                                <DataItem label="Payback Period" value={`${results.monthlySavings > 0 ? ((params.capex.vehicleCost * (params.capex.downPaymentPercent / 100) * params.capex.numVehicles) / results.monthlySavings).toFixed(1) : '99+'} Months`} />
                                            </div>
                                        </div>
                                    </Card>

                                    <Card title="Investment Suitability">
                                        <div className={`p-4 rounded-xl border-l-4 ${results.monthlySavings > 0 ? 'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-500 dark:border-emerald-400' : 'bg-rose-50 dark:bg-rose-900/20 border-rose-500 dark:border-rose-400'}`}>
                                            <div className="flex items-center gap-3">
                                                <i className={`ph-fill ${results.monthlySavings > 0 ? 'ph-check-circle text-emerald-500 dark:text-emerald-400' : 'ph-warning-circle text-rose-500 dark:text-rose-400'} text-3xl`}></i>
                                                <div>
                                                    <h4 className={`text-lg font-bold ${results.monthlySavings > 0 ? 'text-emerald-800 dark:text-emerald-200' : 'text-rose-800 dark:text-rose-200'}`}>
                                                        {results.monthlySavings > 0 ? 'Favorable Investment' : 'High Risk / Hold Decision'}
                                                    </h4>
                                                    <p className="text-sm text-slate-600 dark:text-slate-300 mt-1">
                                                        {results.monthlySavings > 0
                                                            ? `Owning the fleet is expected to save ₹${Math.round(results.monthlySavings).toLocaleString()} monthly compared to outsource.`
                                                            : `Outsourcing is currently cheaper. Consider increasing utilization or negotiating lower costs.`}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </Card>
                                </div>

                                <div className="lg:col-span-1">
                                    <Card title="AI Consultant Report" className="h-full min-h-[400px] bg-white dark:bg-slate-800 text-black dark:text-slate-100 overflow-hidden relative border border-slate-200 dark:border-slate-600">
                                        {loadingAI ? (
                                            <div className="flex flex-col items-center justify-center h-full py-12 space-y-4">
                                                <div className="w-12 h-12 border-4 border-slate-200 dark:border-slate-600 border-t-blue-500 rounded-full animate-spin" />
                                                <p className="text-black dark:text-slate-200 animate-pulse text-sm">Analyzing market dynamics...</p>
                                            </div>
                                        ) : aiReport ? (
                                            <div className="prose prose-sm dark:prose-invert max-w-none overflow-y-auto max-h-[500px] scrollbar-hide prose-p:text-black dark:prose-p:text-slate-200 prose-strong:text-black dark:prose-strong:text-white">
                                                <div className="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg mb-4 text-[10px] font-mono text-black dark:text-slate-200">
                                                    // AI Engine: Gemini 3 Pro (Simulated)
                                                </div>
                                                <div dangerouslySetInnerHTML={{ __html: aiReport.replace(/\n/g, '<br/>') }} className="text-black dark:text-slate-100 leading-relaxed text-sm [&_strong]:font-bold [&_strong]:text-black dark:[&_strong]:text-white" />
                                            </div>
                                        ) : (
                                            <div className="flex flex-col items-center justify-center h-full py-12 text-center">
                                                <i className="ph-duotone ph-brain text-slate-500 dark:text-slate-400 text-6xl mb-4"></i>
                                                <p className="text-black dark:text-slate-300 text-sm">Click "AI Consultant" for deep analysis</p>
                                            </div>
                                        )}
                                        {aiReport && (
                                            <div className="absolute bottom-4 right-4 bg-slate-100 dark:bg-slate-700 text-black dark:text-slate-200 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider border border-slate-200 dark:border-slate-600">
                                                Powered by GenAI
                                            </div>
                                        )}
                                    </Card>
                                </div>
                            </div>

                            <div className="h-8"></div>
                        </div>
                    </main>
                </div>
            );
        }

        // --- Helper Components ---

        function Section({ icon, title, children }) {
            return (
                <div className="space-y-4">
                    <div className="flex items-center gap-2 border-b border-slate-100 dark:border-slate-600 pb-2">
                        <i className={`ph-bold ${icon} text-blue-600 dark:text-blue-400`}></i>
                        <h3 className="text-sm font-bold text-slate-800 dark:text-slate-200 uppercase tracking-wide">{title}</h3>
                    </div>
                    <div className="space-y-3">{children}</div>
                </div>
            );
        }

        function Input({ label, value, onChange, type = "text", ...props }) {
            return (
                <div className="space-y-1">
                    <label className="text-[11px] font-semibold text-slate-500 dark:text-slate-400 uppercase">{label}</label>
                    <input
                        type={type}
                        value={value}
                        onChange={e => onChange(type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value)}
                        className="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-md px-3 py-2 text-sm text-slate-950 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 outline-none transition-shadow placeholder:text-slate-400 dark:placeholder:text-slate-500"
                        {...props}
                    />
                </div>
            );
        }

        function SummaryCard({ label, value, trend, sub, icon }) {
            return (
                <div className="bg-white dark:bg-slate-800 p-5 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-start mb-2">
                        <p className="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">{label}</p>
                        {icon && <i className={`ph-fill ${icon} text-blue-500 dark:text-blue-400 text-lg`}></i>}
                    </div>
                    <p className={`text-2xl font-bold ${trend === 'up' ? 'text-emerald-600 dark:text-emerald-400' : trend === 'down' ? 'text-rose-600 dark:text-rose-400' : 'text-slate-900 dark:text-slate-100'}`}>
                        {value}
                    </p>
                    {sub && <p className="text-[10px] text-slate-400 dark:text-slate-500 mt-1">{sub}</p>}
                </div>
            );
        }

        function Card({ title, children, className = "" }) {
            return (
                <div className={`bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-600 shadow-sm ${className}`}>
                    <h3 className="text-sm font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
                        <div className="w-1.5 h-1.5 bg-blue-600 dark:bg-blue-400 rounded-full" />
                        {title}
                    </h3>
                    {children}
                </div>
            );
        }

        function DataItem({ label, value }) {
            return (
                <div className="flex justify-between items-center py-2 border-b border-slate-50 dark:border-slate-600 last:border-0">
                    <span className="text-xs text-slate-500 dark:text-slate-400">{label}</span>
                    <span className="text-sm font-bold text-slate-800 dark:text-slate-100">{value}</span>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>