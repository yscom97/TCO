<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chennai Fleet TCO & Feasibility Simulator</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Prop Types -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const {
            PieChart, Pie, Cell,
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
        } = Recharts;

        // --- Logic: Ported from calculations.ts ---

        const calculateTCO = (params) => {
            const { capex, opexFixed, opexVariable, market } = params;

            // 1. EMI Calculation
            const principal = capex.vehicleCost * (1 - capex.downPaymentPercent / 100);
            const monthlyRate = capex.interestRate / 100 / 12;
            const n = capex.tenureMonths;

            let monthlyEmi = 0;
            if (monthlyRate > 0) {
                monthlyEmi = (principal * monthlyRate * Math.pow(1 + monthlyRate, n)) / (Math.pow(1 + monthlyRate, n) - 1);
            } else {
                monthlyEmi = principal / n;
            }

            // 2. Fixed Costs (Monthly per vehicle)
            const workingDays = 25; // Assumption
            const driverCost = opexFixed.driverBaseSalary +
                (opexFixed.dailyBhatta * workingDays) +
                (opexFixed.tripIncentive * market.monthlyTrips);

            const helperCost = opexFixed.hasHelper ? opexFixed.helperSalary : 0;

            const annualToMonthly = (val) => val / 12;

            const fixedMonthlyCost = monthlyEmi +
                driverCost +
                helperCost +
                annualToMonthly(opexFixed.annualInsurance) +
                annualToMonthly(opexFixed.annualRoadTax) +
                annualToMonthly(opexFixed.annualFitnessExp) +
                opexFixed.monthlyAdminOverhead;

            // 3. Variable Costs (Per Km)
            const fuelCostPerKm = opexVariable.dieselPrice / opexVariable.mileageKml;
            const tripFixedPerKm = (opexVariable.fastagPerTrip + opexVariable.incidentalsPerTrip) / market.tripDistance;

            const variableCostPerKm = fuelCostPerKm +
                opexVariable.tireCostPerKm +
                opexVariable.maintenancePerKm +
                opexVariable.adBluePerKm +
                tripFixedPerKm;

            // 4. Totals (Monthly)
            const monthlyDistance = market.tripDistance * market.monthlyTrips;
            const totalMonthlyOwnCost = fixedMonthlyCost + (variableCostPerKm * monthlyDistance);

            let totalMonthlyMarketCost = 0;
            if (market.unitType === 'Trip') {
                totalMonthlyMarketCost = market.unitRate * market.monthlyTrips;
            } else if (market.unitType === 'Km') {
                totalMonthlyMarketCost = market.unitRate * monthlyDistance;
            } else {
                // Ton - Simplification: assume 20 Ton for 20FT Triple Axle
                totalMonthlyMarketCost = market.unitRate * 20 * market.monthlyTrips;
            }

            const monthlySavings = totalMonthlyMarketCost - totalMonthlyOwnCost;

            // 5. Break Even Point
            const marketRatePerKm = totalMonthlyMarketCost / (monthlyDistance || 1);
            const breakEvenDistance = marketRatePerKm > variableCostPerKm
                ? fixedMonthlyCost / (marketRatePerKm - variableCostPerKm)
                : 999999;

            const costPerKm = totalMonthlyOwnCost / (monthlyDistance || 1);
            const fuelWeightage = (fuelCostPerKm * monthlyDistance) / (totalMonthlyOwnCost || 1);

            return {
                monthlyEmi,
                fixedMonthlyCost,
                variableCostPerKm,
                totalMonthlyOwnCost: totalMonthlyOwnCost * capex.numVehicles,
                totalMonthlyMarketCost: totalMonthlyMarketCost * capex.numVehicles,
                monthlySavings: monthlySavings * capex.numVehicles,
                breakEvenDistance,
                costPerKm,
                costPerTrip: totalMonthlyOwnCost / (market.monthlyTrips || 1),
                fuelWeightage: fuelWeightage * 100
            };
        };

        const formatINR = (value) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(value);
        const formatLakh = (value) => `₹${(value / 100000).toFixed(2)} L`;

        // --- Report Export: generate HTML and trigger download ---
        const generateReportHtml = (params, results, aiReport) => {
            const date = new Date().toISOString().slice(0, 10);
            const p = params;
            const r = results;
            const aiHtml = aiReport ? aiReport.replace(/\n/g, '<br/>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/^### (.*)$/gm, '<h3 style="margin-top:1em;color:#1e293b">$1</h3>') : '<p class="muted">Run AI Consultant and save again to include AI analysis.</p>';
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chennai Fleet TCO Report - ${date}</title>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; max-width: 900px; margin: 0 auto; padding: 2rem; color: #1e293b; }
        h1 { font-size: 1.5rem; border-bottom: 2px solid #1e3a8a; padding-bottom: 0.5rem; }
        h2 { font-size: 1.1rem; margin-top: 1.5rem; color: #334155; }
        table { width: 100%; border-collapse: collapse; margin: 0.5rem 0 1rem; font-size: 0.9rem; }
        th, td { text-align: left; padding: 0.4rem 0.6rem; border-bottom: 1px solid #e2e8f0; }
        th { background: #f1f5f9; font-weight: 600; }
        .summary { background: #f8fafc; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .summary strong { color: #0f172a; }
        .muted { color: #64748b; font-style: italic; }
        .footer { margin-top: 2rem; font-size: 0.8rem; color: #94a3b8; }
        @media print { body { padding: 1rem; } }
    </style>
</head>
<body>
    <h1>Chennai Fleet TCO & Feasibility Report</h1>
    <p><strong>CJ Logistics - India Branch Operations</strong> · Generated: ${new Date().toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' })}</p>

    <h2>1. Input Assumptions</h2>
    <table>
        <tr><th>CAPEX & Financing</th><th>Value</th></tr>
        <tr><td>Vehicle unit cost</td><td>${formatINR(p.capex.vehicleCost)}</td></tr>
        <tr><td>Down payment</td><td>${p.capex.downPaymentPercent}%</td></tr>
        <tr><td>Interest rate</td><td>${p.capex.interestRate}%</td></tr>
        <tr><td>Tenure</td><td>${p.capex.tenureMonths} months</td></tr>
        <tr><td>Number of vehicles</td><td>${p.capex.numVehicles}</td></tr>
    </table>
    <table>
        <tr><th>Operating (Fixed)</th><th>Value</th></tr>
        <tr><td>Driver base (₹/mo)</td><td>${formatINR(p.opexFixed.driverBaseSalary)}</td></tr>
        <tr><td>Daily bhatta</td><td>${formatINR(p.opexFixed.dailyBhatta)}</td></tr>
        <tr><td>Trip incentive</td><td>${formatINR(p.opexFixed.tripIncentive)}</td></tr>
        <tr><td>Helper</td><td>${p.opexFixed.hasHelper ? formatINR(p.opexFixed.helperSalary) : 'No'}</td></tr>
        <tr><td>Annual insurance / road tax / fitness</td><td>${formatINR(p.opexFixed.annualInsurance)} / ${formatINR(p.opexFixed.annualRoadTax)} / ${formatINR(p.opexFixed.annualFitnessExp)}</td></tr>
        <tr><td>Admin overhead (₹/mo)</td><td>${formatINR(p.opexFixed.monthlyAdminOverhead)}</td></tr>
    </table>
    <table>
        <tr><th>Operating (Variable)</th><th>Value</th></tr>
        <tr><td>Diesel (₹/L), Mileage (km/L)</td><td>${formatINR(p.opexVariable.dieselPrice)} / ${p.opexVariable.mileageKml}</td></tr>
        <tr><td>Tire / Maintenance / AdBlue (₹/km)</td><td>${p.opexVariable.tireCostPerKm} / ${p.opexVariable.maintenancePerKm} / ${p.opexVariable.adBluePerKm}</td></tr>
        <tr><td>FASTag + Incidentals per trip</td><td>${formatINR(p.opexVariable.fastagPerTrip)} + ${formatINR(p.opexVariable.incidentalsPerTrip)}</td></tr>
    </table>
    <table>
        <tr><th>Market Benchmark</th><th>Value</th></tr>
        <tr><td>Unit type / Rate</td><td>${p.market.unitType} @ ${formatINR(p.market.unitRate)} per ${p.market.unitType}</td></tr>
        <tr><td>Trip distance (round trip)</td><td>${p.market.tripDistance} km</td></tr>
        <tr><td>Trips per month</td><td>${p.market.monthlyTrips}</td></tr>
    </table>

    <h2>2. Simulation Results</h2>
    <div class="summary">
        <table>
            <tr><td><strong>Monthly savings (total fleet)</strong></td><td>${formatINR(r.monthlySavings)}</td></tr>
            <tr><td>Break-even distance (km/month)</td><td>${Math.round(r.breakEvenDistance).toLocaleString()} km</td></tr>
            <tr><td>Cost per km</td><td>₹${r.costPerKm.toFixed(2)}</td></tr>
            <tr><td>Cost per trip</td><td>${formatINR(r.costPerTrip)}</td></tr>
            <tr><td>Monthly EMI (per unit)</td><td>${formatINR(r.monthlyEmi)}</td></tr>
            <tr><td>Total monthly own cost</td><td>${formatINR(r.totalMonthlyOwnCost)}</td></tr>
            <tr><td>Total monthly market cost</td><td>${formatINR(r.totalMonthlyMarketCost)}</td></tr>
            <tr><td>Fuel weight in cost</td><td>${r.fuelWeightage.toFixed(1)}%</td></tr>
            <tr><td>Payback (months, down payment)</td><td>${r.monthlySavings > 0 ? ((p.capex.vehicleCost * (p.capex.downPaymentPercent / 100) * p.capex.numVehicles) / r.monthlySavings).toFixed(1) : 'N/A'}</td></tr>
        </table>
    </div>

    <h2>3. AI Consultant (if run)</h2>
    <div>${aiHtml}</div>

    <p class="footer">This report was generated by Chennai Fleet TCO Simulator. For latest assumptions, re-run the simulator and export again.</p>
</body>
</html>`;
        };

        const downloadReport = (params, results, aiReport) => {
            const html = generateReportHtml(params, results, aiReport);
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Chennai_TCO_Report_${new Date().toISOString().slice(0, 10)}_${Date.now().toString().slice(-6)}.html`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // --- Mock AI Logic (Rule-based) ---
        const generateMockAIReport = (params, result) => {
            return new Promise(resolve => {
                setTimeout(() => {
                    const isProfitable = result.monthlySavings > 0;

                    let verdict = isProfitable ? "**VERDICT: INVESTMENT RECOMMENDED**" : "**VERDICT: HOLD / HIGH RISK**";

                    let riskAnalysis = "### Risk Analysis\n";
                    if (result.fuelWeightage > 45) riskAnalysis += "- **High Fuel Dependency**: Fuel accounts for >45% of costs. Small price hikes will impact margins significantly.\n";
                    if (params.market.monthlyTrips < 20) riskAnalysis += "- **Low Utilization**: Current trip count is low. Fixed costs per trip are inflating the TCO.\n";
                    if (result.breakEvenDistance > (params.market.tripDistance * params.market.monthlyTrips)) riskAnalysis += "- **Below Break-even**: Current utilization is below the break-even distance.\n";
                    else riskAnalysis += "- **Healthy Utilization**: Operating above break-even point.\n";

                    let actionPlan = "### Action Plan\n";
                    if (isProfitable) {
                        actionPlan += `1. **Execute Acquisition**: Proceed with purchasing ${params.capex.numVehicles} units.\n2. **Fuel Monitoring**: Implement telematics to maintain mileage at ${params.opexVariable.mileageKml} km/L.\n3. **Driver Retention**: Ensure competitive incentives to maintain ${params.market.monthlyTrips} trips/month.`;
                    } else {
                        actionPlan += `1. **Negotiate Rates**: Market rates are too low to justify ownership. Negotiate higher rates or lower vehicle costs.\n2. **Increase Utilization**: Need to achieve at least ${Math.ceil(result.breakEvenDistance / params.market.tripDistance)} trips/month to break even.\n3. **Review Maintenance**: Check if AMC can be lowered.`;
                    }

                    resolve(`${verdict}\n\n${riskAnalysis}\n${actionPlan}`);
                }, 1000);
            });
        };

        // --- Components ---

        const INITIAL_PARAMS = {
            capex: {
                vehicleCost: 3200000,
                downPaymentPercent: 20,
                interestRate: 11,
                tenureMonths: 60,
                residualValue: 800000,
                numVehicles: 9
            },
            opexFixed: {
                driverBaseSalary: 22000,
                dailyBhatta: 450,
                tripIncentive: 500,
                helperSalary: 12000,
                hasHelper: false,
                annualInsurance: 85000,
                roadTaxType: 'National',
                annualRoadTax: 28000,
                annualFitnessExp: 15000,
                monthlyAdminOverhead: 5000
            },
            opexVariable: {
                dieselPrice: 94.5,
                mileageKml: 4.5,
                tireCostPerKm: 1.8,
                maintenancePerKm: 1.2,
                adBluePerKm: 0.4,
                fastagPerTrip: 1200,
                incidentalsPerTrip: 800
            },
            market: {
                unitType: 'Trip',
                unitRate: 12500,
                tripDistance: 120,
                monthlyTrips: 26
            }
        };

        const COLORS = ['#1e3a8a', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'];

        function App() {
            const [params, setParams] = useState(INITIAL_PARAMS);
            const [aiReport, setAiReport] = useState(null);
            const [loadingAI, setLoadingAI] = useState(false);

            const results = useMemo(() => calculateTCO(params), [params]);

            const handleInputChange = (section, field, value) => {
                setParams(prev => ({
                    ...prev,
                    [section]: {
                        ...prev[section],
                        [field]: value
                    }
                }));
                if (aiReport) setAiReport(null);
            };

            const handleAnalyze = async () => {
                setLoadingAI(true);
                const report = await generateMockAIReport(params, results);
                setAiReport(report);
                setLoadingAI(false);
            };

            // Data for Charts (per-vehicle cost for breakdown)
            const costPerVehicle = results.totalMonthlyOwnCost / params.capex.numVehicles;
            const personnelCost = (params.opexFixed.driverBaseSalary +
                (params.opexFixed.dailyBhatta * 25) +
                (params.opexFixed.tripIncentive * params.market.monthlyTrips)) +
                (params.opexFixed.hasHelper ? params.opexFixed.helperSalary : 0);
            const maintenanceCost = params.opexVariable.maintenancePerKm * params.market.tripDistance * params.market.monthlyTrips;
            const emiShare = (results.monthlyEmi / costPerVehicle) * 100;
            const personnelShare = (personnelCost / costPerVehicle) * 100;
            const maintenanceShare = (maintenanceCost / costPerVehicle) * 100;
            const othersShare = Math.max(0, 100 - results.fuelWeightage - emiShare - personnelShare - maintenanceShare);
            const pieData = [
                { name: 'Fuel', value: results.fuelWeightage },
                { name: 'EMI', value: emiShare },
                { name: 'Personnel', value: personnelShare },
                { name: 'Maintenance', value: maintenanceShare },
                { name: 'Others', value: othersShare }
            ].filter(d => d.value > 0);

            const sensitivityData = useMemo(() => {
                return Array.from({ length: 11 }, (_, i) => {
                    const dist = (results.breakEvenDistance * 0.5) + (results.breakEvenDistance * i * 0.1);
                    if (!isFinite(dist) || dist <= 0) return { distance: 0, Own: 0, Market: 0 };

                    const ownCost = results.fixedMonthlyCost + (results.variableCostPerKm * dist);
                    const marketRatePerKm = (results.totalMonthlyMarketCost / params.capex.numVehicles) / (params.market.tripDistance * params.market.monthlyTrips || 1);
                    const marketCost = marketRatePerKm * dist;
                    return {
                        distance: Math.round(dist),
                        Own: Math.round(ownCost),
                        Market: Math.round(marketCost)
                    };
                });
            }, [results, params]);

            return (
                <div className="min-h-screen flex flex-col bg-slate-50">
                    {/* Header */}
                    <header className="bg-slate-900 text-white px-6 py-4 shadow-lg flex justify-between items-center sticky top-0 z-50">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-lg">
                                <i className="ph-fill ph-truck text-2xl"></i>
                            </div>
                            <div>
                                <h1 className="text-xl font-bold tracking-tight">Chennai Fleet TCO & Feasibility</h1>
                                <p className="text-xs text-slate-400">CJ Logistics - India Branch Operations</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="text-right hidden sm:block">
                                <p className="text-xs text-slate-400">Total Fleet</p>
                                <p className="text-sm font-semibold">{params.capex.numVehicles} x Ashok Leyland 20FT</p>
                            </div>
                            <button
                                onClick={() => downloadReport(params, results, aiReport)}
                                className="bg-slate-700 hover:bg-slate-600 transition-colors px-4 py-2 rounded-lg flex items-center gap-2 font-medium text-sm border border-slate-600"
                                title="Save simulation report as HTML file"
                            >
                                <i className="ph ph-file-arrow-down text-lg"></i>
                                Save Report
                            </button>
                            <button
                                onClick={handleAnalyze}
                                disabled={loadingAI}
                                className="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 transition-colors px-4 py-2 rounded-lg flex items-center gap-2 font-medium text-sm"
                            >
                                {loadingAI ? <i className="ph ph-spinner animate-spin text-lg"></i> : <i className="ph ph-brain text-lg"></i>}
                                AI Consultant
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 flex flex-col lg:flex-row h-full overflow-hidden">
                        {/* Left: Input Sidebar */}
                        <aside className="w-full lg:w-[400px] border-r border-slate-200 bg-white overflow-y-auto p-6 flex flex-col gap-8 shrink-0 h-[calc(100vh-80px)] custom-scrollbar">

                            <Section icon="ph-currency-inr" title="CAPEX & Financing">
                                <Input label="Vehicle Unit Cost (₹)" value={params.capex.vehicleCost} onChange={v => handleInputChange('capex', 'vehicleCost', v)} type="number" />
                                <div className="grid grid-cols-2 gap-3">
                                    <Input label="Downpayment (%)" value={params.capex.downPaymentPercent} onChange={v => handleInputChange('capex', 'downPaymentPercent', v)} type="number" />
                                    <Input label="Interest Rate (%)" value={params.capex.interestRate} onChange={v => handleInputChange('capex', 'interestRate', v)} type="number" />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <Input label="Tenure (Months)" value={params.capex.tenureMonths} onChange={v => handleInputChange('capex', 'tenureMonths', v)} type="number" />
                                    <Input label="Units" value={params.capex.numVehicles} onChange={v => handleInputChange('capex', 'numVehicles', v)} type="number" />
                                </div>
                            </Section>

                            <Section icon="ph-user-gear" title="Operating (Fixed)">
                                <Input label="Driver Base (₹/Mo)" value={params.opexFixed.driverBaseSalary} onChange={v => handleInputChange('opexFixed', 'driverBaseSalary', v)} type="number" />
                                <div className="grid grid-cols-2 gap-3">
                                    <Input label="Daily Bhatta (₹)" value={params.opexFixed.dailyBhatta} onChange={v => handleInputChange('opexFixed', 'dailyBhatta', v)} type="number" />
                                    <Input label="Trip Incentive (₹)" value={params.opexFixed.tripIncentive} onChange={v => handleInputChange('opexFixed', 'tripIncentive', v)} type="number" />
                                </div>
                                <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100">
                                    <label className="text-xs font-semibold text-slate-500">Include Cleaner/Helper?</label>
                                    <input
                                        type="checkbox"
                                        checked={params.opexFixed.hasHelper}
                                        onChange={e => handleInputChange('opexFixed', 'hasHelper', e.target.checked)}
                                        className="w-5 h-5 accent-blue-600"
                                    />
                                </div>
                                {params.opexFixed.hasHelper && (
                                    <Input label="Helper Salary (₹)" value={params.opexFixed.helperSalary} onChange={v => handleInputChange('opexFixed', 'helperSalary', v)} type="number" />
                                )}
                                <Input label="Admin Overhead (₹/Mo)" value={params.opexFixed.monthlyAdminOverhead} onChange={v => handleInputChange('opexFixed', 'monthlyAdminOverhead', v)} type="number" />
                            </Section>

                            <Section icon="ph-gas-pump" title="Operating (Variable)">
                                <div className="grid grid-cols-2 gap-3">
                                    <Input label="Diesel (₹/L)" value={params.opexVariable.dieselPrice} onChange={v => handleInputChange('opexVariable', 'dieselPrice', v)} type="number" />
                                    <Input label="Mileage (km/L)" value={params.opexVariable.mileageKml} onChange={v => handleInputChange('opexVariable', 'mileageKml', v)} type="number" step="0.1" />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <Input label="Tires (₹/km)" value={params.opexVariable.tireCostPerKm} onChange={v => handleInputChange('opexVariable', 'tireCostPerKm', v)} type="number" />
                                    <Input label="Maint (₹/km)" value={params.opexVariable.maintenancePerKm} onChange={v => handleInputChange('opexVariable', 'maintenancePerKm', v)} type="number" />
                                </div>
                                <Input label="FASTag / Trip (₹)" value={params.opexVariable.fastagPerTrip} onChange={v => handleInputChange('opexVariable', 'fastagPerTrip', v)} type="number" />
                            </Section>

                            <Section icon="ph-chart-pie-slice" title="Market Benchmark">
                                <div className="flex gap-2 p-1 bg-slate-100 rounded-lg mb-4">
                                    {['Trip', 'Km', 'Ton'].map(u => (
                                        <button
                                            key={u}
                                            onClick={() => handleInputChange('market', 'unitType', u)}
                                            className={`flex-1 py-1 text-xs font-semibold rounded ${params.market.unitType === u ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}
                                        >
                                            {u}
                                        </button>
                                    ))}
                                </div>
                                <Input label={`Market Rate (₹ per ${params.market.unitType})`} value={params.market.unitRate} onChange={v => handleInputChange('market', 'unitRate', v)} type="number" />
                                <div className="grid grid-cols-2 gap-3">
                                    <Input label="One-way (km)" value={params.market.tripDistance / 2} onChange={v => handleInputChange('market', 'tripDistance', v * 2)} type="number" />
                                    <Input label="Trips / Month" value={params.market.monthlyTrips} onChange={v => handleInputChange('market', 'monthlyTrips', v)} type="number" />
                                </div>
                            </Section>

                            {/* Spacer to allow scrolling to bottom */}
                            <div className="h-6"></div>
                        </aside>

                        {/* Right: Dashboard */}
                        <div className="flex-1 overflow-y-auto p-6 space-y-6 h-[calc(100vh-80px)] bg-slate-50/50 custom-scrollbar">

                            {/* Summary Cards */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <SummaryCard
                                    label="Monthly Savings"
                                    value={formatINR(results.monthlySavings)}
                                    trend={results.monthlySavings > 0 ? 'up' : 'down'}
                                    sub={`Total for ${params.capex.numVehicles} units`}
                                />
                                <SummaryCard
                                    label="Break-even Dist"
                                    value={`${Math.round(results.breakEvenDistance).toLocaleString()} km`}
                                    sub="Monthly mileage needed"
                                    icon="ph-check-circle"
                                />
                                <SummaryCard
                                    label="Cost Per Trip"
                                    value={formatINR(results.costPerTrip)}
                                    sub="Fixed + Variable"
                                />
                                <SummaryCard
                                    label="Cost Per KM"
                                    value={`₹${results.costPerKm.toFixed(2)}`}
                                    sub="Fully loaded cost"
                                />
                            </div>

                            {/* Charts Row */}
                            <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                                <Card title="Sensitivity Analysis (Cost vs Distance)">
                                    <div className="h-[300px] w-full mt-4">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <LineChart data={sensitivityData} margin={{ top: 20, right: 30, left: 10, bottom: 20 }}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                <XAxis dataKey="distance" label={{ value: 'Distance (km)', position: 'insideBottom', offset: -10 }} />
                                                <YAxis tickFormatter={(val) => `₹${(val / 1000).toFixed(0)}k`} />
                                                <Tooltip formatter={(val) => formatINR(val)} />
                                                <Legend verticalAlign="top" height={36} />
                                                <Line type="monotone" dataKey="Own" stroke="#1e3a8a" strokeWidth={3} dot={false} />
                                                <Line type="monotone" dataKey="Market" stroke="#f59e0b" strokeWidth={3} dot={false} strokeDasharray="5 5" />
                                            </LineChart>
                                        </ResponsiveContainer>
                                    </div>
                                    <p className="text-xs text-slate-500 mt-2 italic text-center">
                                        * Intersection: Break-even point where owning becomes cheaper than market
                                    </p>
                                </Card>

                                <Card title="Cost Structure Breakdown">
                                    <div className="h-[300px] flex items-center">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart>
                                                <Pie
                                                    data={pieData}
                                                    innerRadius={60}
                                                    outerRadius={100}
                                                    paddingAngle={5}
                                                    dataKey="value"
                                                >
                                                    {pieData.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                    ))}
                                                </Pie>
                                                <Tooltip />
                                                <Legend />
                                            </PieChart>
                                        </ResponsiveContainer>
                                        <div className="flex flex-col gap-2 pr-6">
                                            {pieData.map((d, i) => (
                                                <div key={d.name} className="flex items-center gap-2 max-w-[120px]">
                                                    <div className="w-3 h-3 rounded-full shrink-0" style={{ backgroundColor: COLORS[i % COLORS.length] }} />
                                                    <span className="text-xs font-medium text-slate-600 truncate">{d.name}: {d.value.toFixed(1)}%</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </Card>
                            </div>

                            {/* AI Insights & Detailed Analysis */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-2 space-y-6">
                                    <Card title="Estimated ROI & Cash Flow">
                                        <div className="grid grid-cols-2 gap-8 mt-4">
                                            <div className="space-y-4">
                                                <DataItem label="Vehicle Unit CAPEX" value={formatLakh(params.capex.vehicleCost)} />
                                                <DataItem label="Downpayment" value={formatLakh(params.capex.vehicleCost * (params.capex.downPaymentPercent / 100))} />
                                                <DataItem label="Monthly EMI (per Unit)" value={formatINR(results.monthlyEmi)} />
                                            </div>
                                            <div className="space-y-4">
                                                <DataItem label="Monthly Opex (Total)" value={formatINR(results.totalMonthlyOwnCost - (results.monthlyEmi * params.capex.numVehicles))} />
                                                <DataItem label="Annual Potential Saving" value={formatINR(results.monthlySavings * 12)} />
                                                <DataItem label="Payback Period" value={`${results.monthlySavings > 0 ? ((params.capex.vehicleCost * (params.capex.downPaymentPercent / 100) * params.capex.numVehicles) / results.monthlySavings).toFixed(1) : '99+'} Months`} />
                                            </div>
                                        </div>
                                    </Card>

                                    <Card title="Investment Suitability">
                                        <div className={`p-4 rounded-xl border-l-4 ${results.monthlySavings > 0 ? 'bg-emerald-50 border-emerald-500' : 'bg-rose-50 border-rose-500'}`}>
                                            <div className="flex items-center gap-3">
                                                <i className={`ph-fill ${results.monthlySavings > 0 ? 'ph-check-circle text-emerald-500' : 'ph-warning-circle text-rose-500'} text-3xl`}></i>
                                                <div>
                                                    <h4 className={`text-lg font-bold ${results.monthlySavings > 0 ? 'text-emerald-800' : 'text-rose-800'}`}>
                                                        {results.monthlySavings > 0 ? 'Favorable Investment' : 'High Risk / Hold Decision'}
                                                    </h4>
                                                    <p className="text-sm text-slate-600 mt-1">
                                                        {results.monthlySavings > 0
                                                            ? `Owning the fleet is expected to save ₹${Math.round(results.monthlySavings).toLocaleString()} monthly compared to market hiring.`
                                                            : `Market hiring is currently cheaper. Consider increasing utilization or negotiating lower maintenance costs.`}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </Card>
                                </div>

                                <div className="lg:col-span-1">
                                    <Card title="AI Consultant Report" className="h-full min-h-[400px] bg-slate-900 text-white overflow-hidden relative border-none">
                                        {loadingAI ? (
                                            <div className="flex flex-col items-center justify-center h-full py-12 space-y-4">
                                                <div className="w-12 h-12 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin" />
                                                <p className="text-slate-400 animate-pulse text-sm">Analyzing market dynamics...</p>
                                            </div>
                                        ) : aiReport ? (
                                            <div className="prose prose-invert prose-sm max-w-none overflow-y-auto max-h-[500px] scrollbar-hide">
                                                <div className="bg-slate-800/50 p-3 rounded-lg mb-4 text-[10px] font-mono text-blue-400">
                                                    // AI Engine: Gemini 3 Pro (Simulated)
                                                </div>
                                                <div dangerouslySetInnerHTML={{ __html: aiReport.replace(/\n/g, '<br/>') }} className="text-slate-300 leading-relaxed text-sm" />
                                            </div>
                                        ) : (
                                            <div className="flex flex-col items-center justify-center h-full py-12 text-center">
                                                <i className="ph-duotone ph-brain text-slate-700 text-6xl mb-4"></i>
                                                <p className="text-slate-500 text-sm">Click "AI Consultant" for deep analysis</p>
                                            </div>
                                        )}
                                        {aiReport && (
                                            <div className="absolute bottom-4 right-4 bg-blue-600/20 text-blue-400 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">
                                                Powered by GenAI
                                            </div>
                                        )}
                                    </Card>
                                </div>
                            </div>

                            <div className="h-8"></div>
                        </div>
                    </main>
                </div>
            );
        }

        // --- Helper Components ---

        function Section({ icon, title, children }) {
            return (
                <div className="space-y-4">
                    <div className="flex items-center gap-2 border-b border-slate-100 pb-2">
                        <i className={`ph-bold ${icon} text-blue-600`}></i>
                        <h3 className="text-sm font-bold text-slate-800 uppercase tracking-wide">{title}</h3>
                    </div>
                    <div className="space-y-3">{children}</div>
                </div>
            );
        }

        function Input({ label, value, onChange, type = "text", ...props }) {
            return (
                <div className="space-y-1">
                    <label className="text-[11px] font-semibold text-slate-500 uppercase">{label}</label>
                    <input
                        type={type}
                        value={value}
                        onChange={e => onChange(type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value)}
                        className="w-full bg-slate-50 border border-slate-200 rounded-md px-3 py-2 text-sm text-slate-950 focus:ring-2 focus:ring-blue-500 outline-none transition-shadow"
                        {...props}
                    />
                </div>
            );
        }

        function SummaryCard({ label, value, trend, sub, icon }) {
            return (
                <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-start mb-2">
                        <p className="text-xs font-semibold text-slate-500 uppercase">{label}</p>
                        {icon && <i className={`ph-fill ${icon} text-blue-500 text-lg`}></i>}
                    </div>
                    <p className={`text-2xl font-bold ${trend === 'up' ? 'text-emerald-600' : trend === 'down' ? 'text-rose-600' : 'text-slate-900'}`}>
                        {value}
                    </p>
                    {sub && <p className="text-[10px] text-slate-400 mt-1">{sub}</p>}
                </div>
            );
        }

        function Card({ title, children, className = "" }) {
            return (
                <div className={`bg-white p-6 rounded-2xl border border-slate-200 shadow-sm ${className}`}>
                    <h3 className="text-sm font-bold text-slate-800 flex items-center gap-2">
                        <div className="w-1.5 h-1.5 bg-blue-600 rounded-full" />
                        {title}
                    </h3>
                    {children}
                </div>
            );
        }

        function DataItem({ label, value }) {
            return (
                <div className="flex justify-between items-center py-2 border-b border-slate-50 last:border-0">
                    <span className="text-xs text-slate-500">{label}</span>
                    <span className="text-sm font-bold text-slate-800">{value}</span>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>